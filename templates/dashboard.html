{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- User Info Sidebar -->
    <div class="col-lg-3 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-person"></i> User Profile</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <i class="bi bi-person-circle display-4 text-muted"></i>
                </div>
                <p><strong>User ID:</strong><br>{{ user_id }}</p>
                <p><strong>Email:</strong><br>{{ email }}</p>
                <div class="mt-3">
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle"></i> Authenticated
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="col-lg-9">
        <!-- Agent Status -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-robot"></i> {{ manifest.name }}</h5>
                <span class="badge bg-info" id="agent-status">Loading...</span>
            </div>
            <div class="card-body">
                <p class="text-muted">{{ manifest.description }}</p>
                <div class="row g-3">
                    <div class="col-md-6">
                        <small class="text-muted">Agent ID:</small><br>
                        <code>{{ manifest.id }}</code>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">Version:</small><br>
                        <span class="badge bg-secondary">{{ manifest.version }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consent Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-shield-check"></i> Consent Management</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Grant specific permissions to the agent. Each permission is time-limited and can be revoked at any time.
                </p>
                
                <div class="row g-4">
                    <!-- Email Access -->
                    <div class="col-md-6">
                        <div class="card border h-100" id="email-consent-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-envelope-open text-info fs-3 me-3"></i>
                                    <div>
                                        <h6 class="mb-0">Email Access</h6>
                                        <small class="text-muted">vault.read.email</small>
                                    </div>
                                </div>
                                <p class="text-sm mb-3">
                                    Allows the agent to read your unread emails to identify potential calendar events.
                                </p>
                                <div id="email-status" class="mb-3">
                                    <span class="badge bg-secondary">Not Granted</span>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-sm" onclick="grantConsent('email')" 
                                            id="grant-email-btn">
                                        <i class="bi bi-check"></i> Grant Permission
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="revokeConsent('email')" 
                                            id="revoke-email-btn" style="display: none;">
                                        <i class="bi bi-x"></i> Revoke Permission
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Access -->
                    <div class="col-md-6">
                        <div class="card border h-100" id="calendar-consent-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-calendar-plus text-success fs-3 me-3"></i>
                                    <div>
                                        <h6 class="mb-0">Calendar Write</h6>
                                        <small class="text-muted">vault.write.calendar</small>
                                    </div>
                                </div>
                                <p class="text-sm mb-3">
                                    Allows the agent to create new events in your Google Calendar.
                                </p>
                                <div id="calendar-status" class="mb-3">
                                    <span class="badge bg-secondary">Not Granted</span>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-sm" onclick="grantConsent('calendar')" 
                                            id="grant-calendar-btn">
                                        <i class="bi bi-check"></i> Grant Permission
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="revokeConsent('calendar')" 
                                            id="revoke-calendar-btn" style="display: none;">
                                        <i class="bi bi-x"></i> Revoke Permission
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Execution -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-play-circle"></i> Execute Agent</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info" role="alert" id="execution-requirements">
                    <i class="bi bi-info-circle"></i>
                    <strong>Requirements:</strong> Both email and calendar permissions must be granted before running the agent.
                </div>
                
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg" onclick="runAgent()" id="run-agent-btn" disabled>
                        <i class="bi bi-play-fill"></i> Run Calendar Agent
                    </button>
                </div>
                
                <!-- Execution Results -->
                <div id="execution-results" style="display: none;" class="mt-4">
                    <h6>Execution Results:</h6>
                    <div class="alert" id="results-content"></div>
                </div>
                
                <!-- Loading Spinner -->
                <div id="execution-loading" style="display: none;" class="text-center mt-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Processing emails and creating calendar events...</p>
                </div>
            </div>
        </div>

        <!-- Privacy Notice -->
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="bi bi-shield-exclamation"></i> Privacy Notice</h6>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>Your data is secure:</strong></p>
                <ul class="mb-0">
                    <li>All permissions are time-limited and revocable</li>
                    <li>Data is encrypted using AES-256-GCM</li>
                    <li>Agent actions are cryptographically verified</li>
                    <li>No data is stored on our servers</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard JavaScript functionality
let statusInterval;

document.addEventListener('DOMContentLoaded', function() {
    updateStatus();
    statusInterval = setInterval(updateStatus, 5000); // Update every 5 seconds
});

function updateStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            if (data.authenticated) {
                updateConsentStatus(data.consent_status);
                updateAgentStatus(data.agent_ready);
            }
        })
        .catch(error => {
            console.error('Status update failed:', error);
        });
}

function updateConsentStatus(consentStatus) {
    // Update email consent
    if (consentStatus.email) {
        updateConsentCard('email', consentStatus.email.valid, consentStatus.email.reason);
    }
    
    // Update calendar consent
    if (consentStatus.calendar) {
        updateConsentCard('calendar', consentStatus.calendar.valid, consentStatus.calendar.reason);
    }
    
    // Update run button
    const allValid = consentStatus.email?.valid && consentStatus.calendar?.valid;
    document.getElementById('run-agent-btn').disabled = !allValid;
    
    if (allValid) {
        document.getElementById('execution-requirements').style.display = 'none';
    } else {
        document.getElementById('execution-requirements').style.display = 'block';
    }
}

function updateConsentCard(type, isValid, reason) {
    const statusEl = document.getElementById(`${type}-status`);
    const grantBtn = document.getElementById(`grant-${type}-btn`);
    const revokeBtn = document.getElementById(`revoke-${type}-btn`);
    const card = document.getElementById(`${type}-consent-card`);
    
    if (isValid) {
        statusEl.innerHTML = '<span class="badge bg-success"><i class="bi bi-check"></i> Active</span>';
        grantBtn.style.display = 'none';
        revokeBtn.style.display = 'block';
        card.classList.add('border-success');
        card.classList.remove('border-danger');
    } else {
        statusEl.innerHTML = '<span class="badge bg-secondary">Not Granted</span>';
        grantBtn.style.display = 'block';
        revokeBtn.style.display = 'none';
        card.classList.remove('border-success', 'border-danger');
        
        if (reason && reason !== 'Not Granted') {
            statusEl.innerHTML = `<span class="badge bg-danger">Invalid</span><br><small class="text-danger">${reason}</small>`;
            card.classList.add('border-danger');
        }
    }
}

function updateAgentStatus(isReady) {
    const statusEl = document.getElementById('agent-status');
    if (isReady) {
        statusEl.textContent = 'Ready';
        statusEl.className = 'badge bg-success';
    } else {
        statusEl.textContent = 'Waiting for Permissions';
        statusEl.className = 'badge bg-warning';
    }
}

function grantConsent(scope) {
    const formData = new FormData();
    formData.append('scope', scope);
    
    fetch('/consent', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus();
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.error || 'Failed to grant consent');
        }
    })
    .catch(error => {
        showAlert('danger', 'Network error occurred');
        console.error('Consent error:', error);
    });
}

function revokeConsent(scope) {
    const formData = new FormData();
    formData.append('scope', scope);
    
    fetch('/revoke_consent', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus();
            showAlert('warning', data.message);
        } else {
            showAlert('danger', data.error || 'Failed to revoke consent');
        }
    })
    .catch(error => {
        showAlert('danger', 'Network error occurred');
        console.error('Revoke error:', error);
    });
}

function runAgent() {
    const loadingEl = document.getElementById('execution-loading');
    const resultsEl = document.getElementById('execution-results');
    const runBtn = document.getElementById('run-agent-btn');
    
    // Show loading state
    loadingEl.style.display = 'block';
    resultsEl.style.display = 'none';
    runBtn.disabled = true;
    runBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Running...';
    
    fetch('/run_agent', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        loadingEl.style.display = 'none';
        resultsEl.style.display = 'block';
        runBtn.disabled = false;
        runBtn.innerHTML = '<i class="bi bi-play-fill"></i> Run Calendar Agent';
        
        const resultsContent = document.getElementById('results-content');
        
        if (data.success) {
            resultsContent.className = 'alert alert-success';
            resultsContent.innerHTML = `
                <h6><i class="bi bi-check-circle"></i> Success!</h6>
                <p><strong>Events Created:</strong> ${data.result.events_created || 0}</p>
                <p><strong>Status:</strong> ${data.result.status}</p>
                ${data.result.message ? `<p><strong>Message:</strong> ${data.result.message}</p>` : ''}
                ${data.result.links ? `<p><strong>Calendar Links:</strong></p><ul>${data.result.links.map(link => `<li><a href="${link}" target="_blank">View Event</a></li>`).join('')}</ul>` : ''}
            `;
            showAlert('success', 'Agent executed successfully!');
        } else {
            resultsContent.className = 'alert alert-danger';
            resultsContent.innerHTML = `
                <h6><i class="bi bi-exclamation-triangle"></i> Error</h6>
                <p>${data.error}</p>
            `;
            showAlert('danger', 'Agent execution failed');
        }
    })
    .catch(error => {
        loadingEl.style.display = 'none';
        runBtn.disabled = false;
        runBtn.innerHTML = '<i class="bi bi-play-fill"></i> Run Calendar Agent';
        showAlert('danger', 'Network error occurred');
        console.error('Agent execution error:', error);
    });
}

function showAlert(type, message) {
    const alertsContainer = document.querySelector('.container.mt-3');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertsContainer.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
